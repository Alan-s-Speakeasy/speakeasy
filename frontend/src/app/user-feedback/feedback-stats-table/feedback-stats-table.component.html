<div class="row p-2">
  <table class="table table-striped table-bordered">
    <thead>
    <tr *ngIf="this.ratingRequests">
      <th scope="col" style="width : 1%">
      </th>
      <th scope="col" style="width : 1%">
      </th>
      <th scope="col" style="width : 5%">
        <span [ngbTooltip]="'Number of ratings'">
          N
        </span>
      </th>
      <th class="">
        {{ authorPerspective ? "Author" : "Recipient" }}
        <ng-template #popoverContentUsers>
          <div>
            <input
              id="table-complete-search"
              type="text"
              class="form-control"
              placeholder="Search username"
              [(ngModel)]="usernameFilter"
            />
          </div>
        </ng-template>
        <span
          type="button"
          [ngbPopover]="popoverContentUsers"
          [autoClose]="'outside'"
          popoverTitle=""
          popoverClass="increase-popover-width"
          placement="bottom">
              <i class="fa fa-search"></i>
          </span>
      </th>
      <ng-container *ngFor="let request of this.ratingRequests">
        <th class="" *ngIf="!nonOptionQuestionIds?.includes(request.id)">
          <div class="d-flex flex-row justify-content-between">
            <span [ngbTooltip]="'σ² = '+ getStatOfRequest(request.id).variance">
              {{request.shortname}} (μ ={{getStatOfRequest(request.id).average}})
            </span>
            <span type="button" (click)="setSorting(request.id)" class="btn btn-link p-0 text-black">
              <i *ngIf="sortColumn === request.id && sortDirection === 'asc'" class="fas fa-sort-up"></i>
              <i *ngIf="sortColumn === request.id && sortDirection === 'desc'" class="fas fa-sort-down"></i>
              <i *ngIf="sortColumn !== request.id" class="fas fa-sort"></i>
            </span>
          </div>
        </th>
      </ng-container>
    </tr>
    </thead>
    <tbody *ngFor="let entry of getAverageFeedback() | slice: (page - 1) * pageSize : page * pageSize; let i = index">
    <tr class="align-middle">
      <td>
        <button class="btn btn-link text-black" (click)="toggleElement = toggleElement == i ? -1 : i">
          <i class="fa fa-chevron-down" *ngIf="toggleElement == i"></i>
          <i class="fa fa-chevron-right" *ngIf="toggleElement != i"></i>
        </button>
      </td>
      <td>
        <mat-checkbox [checked]="selectedUsernames.includes(entry.username)" (change)="onRowSelected.emit(entry.username)" color="primary"/>
      </td>
      <td>
        {{ entry.responses[0].count }}
      </td>
      <td class="ps-1">{{ entry.username }}</td>
      <ng-container *ngFor="let response of entry.responses">
        <td class="px-1"
            *ngIf="!nonOptionQuestionIds?.includes(response.requestID)">
          {{ response.average }} -
          <span [ngbTooltip]="'μ = ' + response.average + '- σ² = ' + response.variance">
            <i>{{ mapValueToFeedbackRequestText(response) }} </i>
          </span>
          <span class="fa fa-warning" *ngIf="isControversial(response, getStatOfRequest(response.requestID))"
                [ngbTooltip]="'This bot is controversial, meaning that user generally disagree on its ratings.'"></span>
        </td>
      </ng-container>
    </tr>
    <tr *ngIf="toggleElement == i">
      <td [colSpan]="entry.responses.length + 4">
        <table class="table table-sm ">
          <thead>
          <tr class="table-secondary">
            <th>{{ authorPerspective ? "Recipient" : "Author" }}</th>
            <th *ngFor="let question of this.ratingRequests">{{ question.shortname }}</th>
            <th></th>
          </tr>
          </thead>
          <tbody *ngFor="let userFeedback of getFeedbacks(entry.username)">
          <tr class="table-secondary">
            <td class="p-2">{{ this.authorPerspective ? userFeedback.recipient : userFeedback.author }}</td>
            <ng-container *ngFor="let response of userFeedback.responses">
              <ng-container
                *ngIf="!nonOptionQuestionIds?.includes(response.id); then optionQuestion; else nonOptionQuestion">
              </ng-container>
              <ng-template #optionQuestion>
                <td class="p-2">{{ idToText(response) }}</td>
              </ng-template>
              <ng-template #nonOptionQuestion>
                <td>
                  <p class="fa fa-book btn col-1" (click)="openImpression(readImpression, response)"><i>&nbsp;Read</i>
                  </p>
                </td>
              </ng-template>
            </ng-container>
            <td>
              <span>
                <span type="button" [ngbTooltip]="'Watch this chat'"
                      (click)="watch(userFeedback.roomId)"
                >
                  <i class="fa fa-eye"></i>
                </span>
              </span>
            </td>
          </tr>
          </tbody>
        </table>
      </td>
    </tr>
    </tbody>
  </table>
  <div class="d-flex justify-content-between p-2">
    <ngb-pagination
                    [pageSize]="pageSize"
                    [(page)]="page"
                    [collectionSize]="this.getAverageFeedback().length"
                    [maxSize]="5" [rotate]="true"
    ></ngb-pagination>
  </div>
</div>
