<div class="container mt-3">

  <br>

  <div class="row p-2">
    <div class="col-9">
      <h3>Evaluation Feedback Overview</h3>
    </div>
    <div class="col-3">
      <button type="button" class="btn btn-secondary float-end" (click)="home()">Home</button>
    </div>
  </div>

  <div class="row">
    <div class="col-4">
      <mat-form-field appearance="fill" class="col-12">
        <mat-label>Filter User</mat-label>
        <mat-select [(value)]="selectedUsername" (selectionChange)="updateUsernameAndCharts()">
          <mat-option [value]="null">None</mat-option>
          <mat-option *ngFor="let username of usernames" [value]="username">
            {{username}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="col-2 p-2">
      <mat-button-toggle-group class="border-0" (change)="toggleDirection($event.value)">
        <mat-button-toggle checked value="author"><b>Author</b></mat-button-toggle>
        <mat-button-toggle value="recipient"><b>Recipient</b></mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  </div>


  <div class="row mt-5 mb-5">
    <div class="col-4" id="chart" *ngFor="let chartOptions of allChartOptions">
      <apx-chart
        [series]="chartOptions.series"
        [colors]="chartOptions.colors"
        [chart]="chartOptions.chart"
        [dataLabels]="chartOptions.dataLabels"
        [plotOptions]="chartOptions.plotOptions"
        [yaxis]="chartOptions.yaxis"
        [xaxis]="chartOptions.xaxis"
        [title]="chartOptions.title"
      ></apx-chart>
    </div>
  </div>

  <div class="row">
    <h3>Detailed Evaluation Feedback</h3>
  </div>

  <span>Average Evaluation per User. Click to expand</span>

  <div class="row p-2">
    <table class="table">
      <thead>
      <tr *ngIf="this.ratingForm">
        <th class="px-0">{{authorPerspective ? "Author" : "Recipient"}}</th>
        <th class="px-0" *ngFor="let question of this.ratingForm.slice(0, -1)">{{question.shortname}}</th>
      </tr>
      </thead>
      <tbody *ngFor="let entry of getAverageFeedback(); let i = index">
      <tr class="align-middle" role="button" (click)="toggleElement = toggleElement == i ? -1 : i">
        <td class="px-0">{{entry.username}}</td>
        <td class="px-0" *ngFor="let response of entry.responses.slice(0, -1)">{{idToText(response)}}</td>
      </tr>
      <tr @inOutAnimation *ngIf="toggleElement == i">
        <td [colSpan]="entry.responses.length">
          <table class="table table-sm small">
            <thead>
            <tr class="table-secondary">
              <th>{{authorPerspective ? "Recipient" : "Author"}}</th>
              <th *ngFor="let question of this.ratingForm">{{question.shortname}}</th>
            </tr>
            </thead>
            <tbody *ngFor="let userFeedback of getFeedbacks(entry.username)">
            <tr class="table-secondary">
              <td class="p-2">{{this.authorPerspective ? userFeedback.recipient : userFeedback.author}}</td>
              <td class="p-2" *ngFor="let response of userFeedback.responses.slice(0, -1)">{{idToText(response)}}</td>
              <td *ngFor="let impression of userFeedback.responses.slice(-1)">
                <p class="fa fa-book btn col-1" (click)="openImpression(readImpression, impression)"><i>&nbsp;Read</i></p>
              </td>
            </tr>
            </tbody>
          </table>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<ng-template #readImpression let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Impression</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss()">
      <span aria-hidden="true">Ã—</span>
    </button>
  </div>
  <div class="modal-body">
    <p>{{this.impressionToRead}}</p>
  </div>
</ng-template>
